<html>
  <head>
    <script src="http://d3js.org/d3.v3.min.js"></script>
  <head>
  <body>
    <div id="viz"></div>
    <script>

var monthNames = [
    'Jan', 'Feb', 'Mar', 'Apr',
    'May', 'Jun', 'Jul', 'Aug',
    'Sep', 'Oct', 'Nov', 'Dec'
];

var format = d3.time.format('%Y-%b');

var w = 500,
    h = 400,
    m = 100;

var x = d3.time.scale()
    .range([0,w]);

var y = d3.scale.linear()
    .range([h,0]);

var y2 = d3.scale.linear()
    .range([h,0]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient('bottom');

var yAxis = d3.svg.axis()
    .scale(y)
    .orient('left');

var y2Axis = d3.svg.axis()
    .scale(y2)
    .orient('right');

var svg = d3.select('#viz')
    .append('svg')
    .attr('width', w+2*m)
    .attr('height', h+2*m)
    .append('g')
    .attr('transform','translate('+m+','+m+')');

function month(d) { return d.month; }
function value(d) { return d.value; }

d3.csv("data/CEU0000000001.csv", function(err, years) {

    var months = [];

    years.forEach(function(year) {
        monthNames.forEach(function(month) {
            if ( year[month] === ' ' ) return;
            months.push({
                month: format.parse(year.Year+'-'+month),
                value: parseInt(year[month])
            });
        });
    });

    function change(d, i) {
        if ( !months[i-1] ) return 0;
        return d.value - months[i-1].value;
    }

    var changeLine = d3.svg.line()
        .x(function(d) { return x( month(d) ); })
        .y(function(d, i) { return y2( change(d, i) ); });

    x.domain(d3.extent(months, month));
    y.domain(d3.extent(months, value));
    y2.domain(d3.extent(months, change));

    svg.append('g')
        .attr('class', 'x axis')
        .attr('transform', 'translate(0,'+h+')')
        .call(xAxis);

    svg.append('g')
        .attr('class', 'y axis')
        .call(yAxis);

    svg.append('g')
        .attr('class', 'y2 axis')
        .attr('transform', 'translate('+w+',0)')
        .call(y2Axis);

    svg.selectAll('.dot')
        .data(months)
      .enter().append('circle')
        .attr('class', 'dot')
        .attr('r', 4)
        .attr('cx', function(d) { return x( month(d) ); })
        .attr('cy', function(d) { return y( value(d) ); });

    svg.append('path')
        .attr('d', changeLine(months))
        .attr('stroke', 'blue')
        .attr('stroke-width', 1);

    svg.selectAll('.dot2')
        .data(months)
      .enter().append('circle')
        .attr('class', 'dot2')
        .attr('r', 4)
        .attr('fill', 'red')
        .attr('cx', function(d) { return x( month(d) ); })
        .attr('cy', function(d, i) { return y2( change(d, i) ); });

});

    </script>
  </body>
</html>
