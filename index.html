<html>
  <head>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="https://raw.github.com/square/crossfilter/master/crossfilter.min.js"></script>
  <head>
  <body>
    <div id="viz"></div>
    <script>

var monthNames = [
    'Jan', 'Feb', 'Mar', 'Apr',
    'May', 'Jun', 'Jul', 'Aug',
    'Sep', 'Oct', 'Nov', 'Dec'
];

var recessions = [
    [new Date(1948, 8, 1), new Date(1950, 7, 1)],
    [new Date(1953, 6, 1), new Date(1955, 6, 1)],
    [new Date(1957, 7, 1), new Date(1959, 4, 1)],
    [new Date(1960, 3, 1), new Date(1961, 12, 1)],
    [new Date(1970, 2, 1), new Date(1971, 9, 1)],
    [new Date(1974, 9, 1), new Date(1976, 2, 1)],
    [new Date(1980, 2, 1), new Date(1981, 2, 1)],
    [new Date(1981, 6, 1), new Date(1983, 11, 1)],
    [new Date(1990, 5, 1), new Date(1993, 2, 1)],
    [new Date(2001, 1, 1), new Date(2005, 2, 1)],
    [new Date(2007, 12, 1), new Date()]
];

var format = d3.time.format('%Y-%b');

var w = 500,
    h = 400,
    m = 100;

var x = d3.scale.linear()
    .domain([0,70])
    .range([0,w]);

var y = d3.scale.linear()
    .range([h,0]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient('bottom');

var yAxis = d3.svg.axis()
    .scale(y)
    .orient('left');

var svg = d3.select('#viz')
    .append('svg')
    .attr('width', w+2*m)
    .attr('height', h+2*m)
    .append('g')
    .attr('transform','translate('+m+','+m+')');

function month(d) { return d.month; }

var byMonth = d3.nest()
    .key(month);

var monthsByMonth;

d3.csv("data/CES0000000001.csv", function(err, years) {

    var months = [];

    years.forEach(function(year) {
        monthNames.forEach(function(month) {
            if ( year[month] === ' ' ) return;
            months.push({
                month: format.parse(year.Year+'-'+month),
                value: parseInt(year[month])
            });
        });
    });

    var first = recessions[9][0];
    var last = recessions[9][1];

    var xf = crossfilter(months);
    var monthDim = xf.dimension(month);
    monthDim.filterRange([first, last]);

    function monthsAfter(start) {
        var sy = start.month.getFullYear();
        var sm = start.month.getMonth();
        return function(d) {
            var ys = d.month.getFullYear() - sy;
            var ms = d.month.getMonth() - sm;
            return 12*ys + ms;
        };
    }

    function changeSince(start) {
        return function(d) {
            return (d.value / start.value) - 1;
        };
    }

    monthsByMonth = byMonth.map( months );
    var start = monthsByMonth[first][0];

    var monthsAfterStart = monthsAfter(start);
    var changeSinceStart = changeSince(start);

    var changeLine = d3.svg.line()
        .x(function(d) { return x( monthsAfterStart(d) ); })
        .y(function(d, i) { return y( changeSinceStart(d, i) ); });

    var selection = monthDim.bottom( Infinity );

    y.domain(d3.extent(selection, changeSinceStart));

    svg.append('g')
        .attr('class', 'x axis')
        .attr('transform', 'translate(0,'+h+')')
        .call(xAxis);

    svg.append('g')
        .attr('class', 'y axis')
        .call(yAxis);

    svg.append('path')
        .attr('d', changeLine(selection))
        .attr('stroke', 'blue')
        .attr('stroke-width', 1)
        .attr('fill', 'none');

});

    </script>
  </body>
</html>
